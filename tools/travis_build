#!/bin/bash

set -e -o pipefail

# This script will attempt to build Kerkerkruip with Travis CI

# Inform is a pain and prints the progress markers to stderr, so redirect it to stdout
i7 -s blorb=1,zcode=g -c Kerkerkruip.inform 2>&1 | grep -Ev "ve also read|\+\+ |::#+"

cp Kerkerkruip.inform/Build/output.gblorb Kerkerkruip.gblorb
cp Kerkerkruip.materials/Kerkerkruip.ini Kerkerkruip.ini

if [[ $TRAVIS_BRANCH == "master" ]]; then
	zip kerkerkruip-git Kerkerkruip.gblorb Kerkerkruip.ini
	sshpass -e sftp -oBatchMode=no -oStrictHostKeyChecking=no -b - ${KUSER}@${KSERVER} <<- !
		cd downloads.kerkerkruip.org
		put kerkerkruip-git.zip
		bye
	!
fi
